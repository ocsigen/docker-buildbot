#! /bin/sh

if [ "$USER" != "ci" ]; then
  echo "Should be runned as 'ci'"
  exit 1
fi

set -e
set -x

git --git-dir=/builds/cache/git/ remote update
cd /builds/cache/git/ && tar cf /builds/cache/git.tar .

git --git-dir=/builds/cache/opam-repository/.git fetch
if [ ! -z "$(git --git-dir=/builds/cache/opam-repository/.git log HEAD..origin/master --oneline)" ] ; then
  git --git-dir=/builds/cache/opam-repository/.git --work-tree=/builds/cache/opam-repository reset --hard origin/master
  cd /builds/cache/opam-repository \
     && opam-admin make -g \
     && tar cf /builds/cache/opam-repository.tar .
fi

OPAM_VERSION=1.2.0

if [ ! -f /builds/cache/opam-${OPAM_VERSION} ]; then
  wget https://github.com/ocaml/opam/releases/download/${OPAM_VERSION}/opam-${OPAM_VERSION}-x86_64-Linux \
       -O /builds/cache/opam-${OPAM_VERSION}
  rm -f /builds/cache/opam
  ln /builds/cache/opam-${OPAM_VERSION} /builds/cache/opam
  chmod +x /builds/cache/opam
fi
